var racks = {
    "1": {
        "lat": 59.92758,
        "lon": 10.71004,
        "name": "Middelthunsgate",
        "size": 18
    },
    "2": {
        "lat": 59.9281,
        "lon": 10.70865,
        "name": "Middelthunsgate 28",
        "size": 18
    },
    "4": {
        "lat": 59.9228,
        "lon": 10.73877,
        "name": "Hallingsgate 2",
        "size": 9
    },
    "5": {
        "lat": 59.91379,
        "lon": 10.74287,
        "name": "Egertorget",
        "size": 18
    },
    "6": {
        "lat": 59.9138,
        "lon": 10.73567,
        "name": "Stortingsgata",
        "size": 15
    },
    "7": {
        "lat": 59.91114,
        "lon": 10.73044,
        "name": "Vestbanen Nord",
        "size": 12
    },
    "8": {
        "lat": 59.91104,
        "lon": 10.73022,
        "name": "Vestbanen Sør",
        "size": 12
    },
    "9": {
        "lat": 59.91272,
        "lon": 10.74815,
        "name": "Kirkeristen Vest",
        "size": 12
    },
    "10": {
        "lat": 59.91259,
        "lon": 10.74832,
        "name": "Kirkeristen Øst",
        "size": 12
    },
    "11": {
        "lat": 59.91262,
        "lon": 10.72535,
        "name": "Ruseløkkveien",
        "size": 12
    },
    "12": {
        "lat": 59.92442,
        "lon": 10.71288,
        "name": "Amaldus Nielsens plass",
        "size": 12
    },
    "13": {
        "lat": 59.92885,
        "lon": 10.71716,
        "name": "Majorstua",
        "size": 18
    },
    "14": {
        "lat": 59.91237,
        "lon": 10.73178,
        "name": "Olav Vs gate",
        "size": 6
    },
    "15": {
        "lat": 59.90831,
        "lon": 10.74174,
        "name": "Bankplassen/Kirkegata",
        "size": 21
    },
    "16": {
        "lat": 59.9245,
        "lon": 10.7402,
        "name": "Knud Knudsens plass",
        "size": 12
    },
    "17": {
        "lat": 59.91883,
        "lon": 10.73631,
        "name": "Pilestredet 33",
        "size": 24
    },
    "18": {
        "lat": 59.91011,
        "lon": 10.73829,
        "name": "Christiania Torv",
        "size": 12
    },
    "19": {
        "lat": 59.91366,
        "lon": 10.75677,
        "name": "Oslo Plaza",
        "size": 9
    },
    "20": {
        "lat": 59.9136,
        "lon": 10.75766,
        "name": "Brugata Nord",
        "size": 30
    },
    "21": {
        "lat": 59.92517,
        "lon": 10.73095,
        "name": "Bislet Stadion",
        "size": 24
    },
    "22": {
        "lat": 59.91205,
        "lon": 10.75027,
        "name": "Europarådets plass",
        "size": 9
    },
    "23": {
        "lat": 59.91346,
        "lon": 10.75784,
        "name": "Brugata Sør",
        "size": 21
    },
    "24": {
        "lat": 59.91533,
        "lon": 10.75146,
        "name": "Arbeidersamfunnets plass",
        "size": 24
    },
    "25": {
        "lat": 59.91415,
        "lon": 10.75181,
        "name": "Storgata 27",
        "size": 12
    },
    "26": {
        "lat": 59.91534,
        "lon": 10.74107,
        "name": "C.J.Hambros plass",
        "size": 12
    },
    "27": {
        "lat": 59.91057,
        "lon": 10.73793,
        "name": "Rådhusgata 27",
        "size": 18
    },
    "28": {
        "lat": 59.93277,
        "lon": 10.73496,
        "name": "Adamstuen",
        "size": 6
    },
    "29": {
        "lat": 59.92965,
        "lon": 10.73277,
        "name": "Thereses gate/Stensgata",
        "size": 9
    },
    "30": {
        "lat": 59.90825,
        "lon": 10.7679,
        "name": "Oslo gate",
        "size": 12
    },
    "31": {
        "lat": 59.91779,
        "lon": 10.75481,
        "name": "Torggata/Jacobs kirke",
        "size": 9
    },
    "32": {
        "lat": 59.91504,
        "lon": 10.72239,
        "name": "Parkveien/Drammensveien",
        "size": 12
    },
    "33": {
        "lat": 59.90761,
        "lon": 10.68706,
        "name": "Bygdøy/Folkemuseet",
        "size": 12
    },
    "34": {
        "lat": 59.91277,
        "lon": 10.75118,
        "name": "Oslo City",
        "size": 12
    },
    "35": {
        "lat": 59.92013,
        "lon": 10.76038,
        "name": "Schous plass - 1",
        "size": 6
    },
    "36": {
        "lat": 59.92043,
        "lon": 10.7611,
        "name": "Schous plass - 2",
        "size": 12
    },
    "37": {
        "lat": 59.93148,
        "lon": 10.76209,
        "name": "Johan Sverdrups plass/Vogts gate",
        "size": 12
    },
    "38": {
        "lat": 59.91991,
        "lon": 10.74341,
        "name": "Ullevålsveien 9",
        "size": 15
    },
    "39": {
        "lat": 59.9126262702819,
        "lon": 10.710338139954082,
        "name": "Munkedamsveien 100, Skillebekk",
        "size": 12
    },
    "40": {
        "lat": 59.92492,
        "lon": 10.77602,
        "name": "Carl Berners",
        "size": 9
    },
    "41": {
        "lat": 59.91026595523588,
        "lon": 10.705103874206543,
        "name": "Frognerstranda v/Kongen",
        "size": 12
    },
    "42": {
        "lat": 59.9149,
        "lon": 10.77391,
        "name": "Tøyen T-bane/Hagegata",
        "size": 12
    },
    "43": {
        "lat": 59.91532,
        "lon": 10.76948,
        "name": "Jens Bjelkes gate",
        "size": 30
    },
    "44": {
        "lat": 59.92234,
        "lon": 10.76161,
        "name": " Sofienberggata",
        "size": 12
    },
    "45": {
        "lat": 59.92984,
        "lon": 10.74361,
        "name": "Geitmyrsveien",
        "size": 9
    },
    "46": {
        "lat": 59.92302,
        "lon": 10.77166,
        "name": "Trondheimsveien 64",
        "size": 12
    },
    "47": {
        "lat": 59.92821,
        "lon": 10.71796,
        "name": "Valkyrieplass",
        "size": 12
    },
    "48": {
        "lat": 59.92607,
        "lon": 10.71019,
        "name": "Frogner stadion v/tenninsbanene",
        "size": 15
    },
    "49": {
        "lat": 59.91947,
        "lon": 10.70885,
        "name": "Frognerveien 35/Amtmann Furus plass",
        "size": 12
    },
    "50": {
        "lat": 59.91027,
        "lon": 10.75027,
        "name": "Havnegata N",
        "size": 30
    },
    "51": {
        "lat": 59.91021,
        "lon": 10.75064,
        "name": "Havnegata S",
        "size": 30
    },
    "52": {
        "lat": 59.91203,
        "lon": 10.76636,
        "name": "Helga Helgesens plass",
        "size": 30
    },
    "53": {
        "lat": 59.92048,
        "lon": 10.73442,
        "name": "Pilestredet 36-38",
        "size": 15
    },
    "54": {
        "lat": 59.92016,
        "lon": 10.71797,
        "name": "Uranienborg skole",
        "size": 15
    },
    "55": {
        "lat": 59.91731,
        "lon": 10.70827,
        "name": "Bygdøy alle 45/Gimle Kino",
        "size": 15
    },
    "56": {
        "lat": 59.9129,
        "lon": 10.74171,
        "name": "Karl Johans gate",
        "size": 12
    },
    "57": {
        "lat": 59.90395,
        "lon": 10.74091,
        "name": "Akershusstranda/Vippetangen",
        "size": 15
    },
    "58": {
        "lat": 59.93092,
        "lon": 10.73581,
        "name": "Brageveien 1",
        "size": 9
    },
    "59": {
        "lat": 59.91334,
        "lon": 10.72699,
        "name": "Dronning Mauds gate 11-15",
        "size": 15
    },
    "60": {
        "lat": 59.9256,
        "lon": 10.76094,
        "name": "Birkelunden",
        "size": 12
    },
    "61": {
        "lat": 59.91529,
        "lon": 10.71499,
        "name": "Bygdøy alle 2",
        "size": 24
    },
    "62": {
        "lat": 59.92797,
        "lon": 10.75113,
        "name": "Alexander Kiellands plass",
        "size": 30
    },
    "63": {
        "lat": 59.92522,
        "lon": 10.75028,
        "name": "Maridalsveien 31",
        "size": 24
    },
    "64": {
        "lat": 59.91333,
        "lon": 10.75018,
        "name": "Skippergata/Storgata",
        "size": 15
    },
    "65": {
        "lat": 59.92677,
        "lon": 10.73828,
        "name": "Ullevålsveien/Collettsgate",
        "size": 12
    },
    "66": {
        "lat": 59.9197,
        "lon": 10.68559,
        "name": "Karenslyst alle",
        "size": 24
    },
    "67": {
        "lat": 59.92247,
        "lon": 10.7209,
        "name": "Holtegata 20",
        "size": 15
    },
    "68": {
        "lat": 59.91697,
        "lon": 10.75874,
        "name": "Storgata 40",
        "size": 12
    },
    "69": {
        "lat": 59.932317,
        "lon": 10.741432,
        "name": "Geitmyrsveien",
        "size": 15
    },
    "70": {
        "lat": 59.92986,
        "lon": 10.71136,
        "name": "Colosseum/Fridtjof Nansensvei",
        "size": 12
    },
    "71": {
        "lat": 59.92982,
        "lon": 10.71595,
        "name": "Slemdalsveien 1-3",
        "size": 18
    },
    "72": {
        "lat": 59.91929,
        "lon": 10.69674,
        "name": "Bygdøy alle",
        "size": 12
    },
    "73": {
        "lat": 59.9191,
        "lon": 10.69273,
        "name": "Bygdøy alle",
        "size": 12
    },
    "74": {
        "lat": 59.91472,
        "lon": 10.74091,
        "name": "Prof.Aschehougs plass",
        "size": 12
    },
    "75": {
        "lat": 59.93478,
        "lon": 10.74945,
        "name": "Uelands gate/Arkitekt Rivertz' plass",
        "size": 15
    },
    "76": {
        "lat": 59.909642,
        "lon": 10.723085,
        "name": "Tjuvholmen",
        "size": 18
    },
    "77": {
        "lat": 59.92081,
        "lon": 10.7334,
        "name": "Pilestredet 46",
        "size": 6
    },
    "78": {
        "lat": 59.92888,
        "lon": 10.76719,
        "name": "Dælenenggata 41",
        "size": 24
    },
    "79": {
        "lat": 59.92875,
        "lon": 10.76745,
        "name": "Fagerheimgata 11",
        "size": 9
    },
    "80": {
        "lat": 59.91675,
        "lon": 10.74925,
        "name": "Møllergata 39",
        "size": 21
    },
    "81": {
        "lat": 59.92378,
        "lon": 10.7408,
        "name": "Waldemar Thranes gate 16",
        "size": 12
    },
    "82": {
        "lat": 59.90336,
        "lon": 10.76742,
        "name": "Oslogate 37",
        "size": 15
    },
    "83": {
        "lat": 59.92208,
        "lon": 10.73116,
        "name": "Parkveien 13",
        "size": 9
    },
    "84": {
        "lat": 59.91138,
        "lon": 10.77628,
        "name": "Jens Bjelkes gate/Sverres gate",
        "size": 21
    },
    "85": {
        "lat": 59.91558,
        "lon": 10.77712,
        "name": "Økernveien/Caltexløkka",
        "size": 30
    },
    "86": {
        "lat": 59.90342,
        "lon": 10.77838,
        "name": "Dyvekesvei/Konows gate",
        "size": 12
    },
    "87": {
        "lat": 59.9232,
        "lon": 10.76618,
        "name": "Helgesens gate 58",
        "size": 18
    },
    "88": {
        "lat": 59.92111,
        "lon": 10.7507,
        "name": "Fredensborgveien 62-64",
        "size": 15
    },
    "89": {
        "lat": 59.91418,
        "lon": 10.73298,
        "name": "Olav Vs gate/Saga Kino",
        "size": 9
    },
    "90": {
        "lat": 59.92669,
        "lon": 10.71636,
        "name": "Maries gate/Majorstuveien",
        "size": 9
    },
    "91": {
        "lat": 59.93237,
        "lon": 10.72164,
        "name": "Suhms gate v/Shell - Marienlyst",
        "size": 12
    },
    "92": {
        "lat": 59.935376,
        "lon": 10.726411,
        "name": "Blindernveien 5",
        "size": 30
    },
    "93": {
        "lat": 59.93782,
        "lon": 10.73059,
        "name": "Sognsveien/Ullevålsalléen",
        "size": 9
    },
    "94": {
        "lat": 59.91411,
        "lon": 10.71548,
        "name": "Drammensveien 33",
        "size": 15
    },
    "95": {
        "lat": 59.90413,
        "lon": 10.7415,
        "name": "Akershusstranda/Vippetangen - 2",
        "size": 15
    },
    "96": {
        "lat": 59.90449,
        "lon": 10.74187,
        "name": "Akershusstranda/Vippetangen - 1",
        "size": 15
    },
    "97": {
        "lat": 59.91093,
        "lon": 10.72791,
        "name": "Dokkveien"
    },
    "98": {
        "lat": 59.91279,
        "lon": 10.72583,
        "name": "Ruseløkkveien",
        "size": 15
    },
    "99": {
        "lat": 59.91062,
        "lon": 10.73759,
        "name": "Rådhusgata 27/Kontraskjæret",
        "size": 18
    },
    "100": {
        "lat": 59.91357,
        "lon": 10.73651,
        "name": "Stortingsgata",
        "size": 15
    },
    "102": {
        "lat": 59.91589,
        "lon": 10.75146,
        "name": "Arbeidersamfunnets plass",
        "size": 18
    },
    "104": {
        "lat": 59.921851,
        "lon": 10.676345,
        "name": "Drammensveien 159/Skøyen",
        "size": 18
    },
    "107": {
        "lat": 59.91576,
        "lon": 10.76279,
        "name": "Nylandsveien/Urtegata/Vahls gate - 1",
        "size": 15
    },
    "108": {
        "lat": 59.91538,
        "lon": 10.76183,
        "name": "Nylandsveien/Urtegata/Vahls gate - 2",
        "size": 15
    },
    "109": {
        "lat": 59.91414,
        "lon": 10.71543,
        "name": "Drammensveien 33/Hydroparken",
        "size": 15
    },
    "110": {
        "lat": 59.93484,
        "lon": 10.74949,
        "name": "Uelands gate/Arkitekt Rivertz' plass",
        "size": 15
    },
    "111": {
        "lat": 59.91366,
        "lon": 10.75681,
        "name": "Brugata",
        "size": 0
    },

    // Merged racks

    "m0": {
        "lat": 59.91109,
        "lon": 10.730329999999999,
        "name": "Vestbanen",
        "size": 24
    },
    "m1": {
        "lat": 59.912655,
        "lon": 10.748235000000001,
        "name": "Kirkeristen",
        "size": 24
    },
    "m2": {
        "lat": 59.912705,
        "lon": 10.72559,
        "name": "Ruseløkkveien",
        "size": 27
    },
    "m3": {
        "lat": 59.91353,
        "lon": 10.75775,
        "name": "Brugata",
        "size": 51
    },
    "m4": {
        "lat": 59.910595,
        "lon": 10.737760000000002,
        "name": "Rådhusgata 27/Kontraskjæret",
        "size": 36
    },
    "m5": {
        "lat": 59.91024,
        "lon": 10.750455,
        "name": "Havnegata",
        "size": 60
    },
    "m6": {
        "lat": 59.90404,
        "lon": 10.741205,
        "name": "Akershusstranda/Vippetangen",
        "size": 30
    },
    "m7": {
        "lat": 59.928815,
        "lon": 10.76732,
        "name": "Dælenenggata 41/Fagerheimgata 11",
        "size": 33
    },
    "m8": {
        "lat": 59.914125,
        "lon": 10.715454999999999,
        "name": "Drammensveien 33/Hydroparken",
        "size": 30
    },
    "m9": {
        "lat": 59.93481,
        "lon": 10.749469999999999,
        "name": "Uelands gate/Arkitekt Rivertz' plass",
        "size": 30
    },
    "m10": {
        "lat": 59.91366,
        "lon": 10.756789999999999,
        "name": "Brugata/Oslo Plaza",
        "size": 9
    }
};

var mergedIdMap = {
    "7": "m0",
    "8": "m0",
    "9": "m1",
    "10": "m1",
    "11": "m2",
    "19": "m10",
    "20": "m3",
    "23": "m3",
    "27": "m4",
    "50": "m5",
    "51": "m5",
    "57": "m6",
    "75": "m9",
    "78": "m7",
    "79": "m7",
    "94": "m8",
    "95": "m6",
    "98": "m2",
    "99": "m4",
    "109": "m8",
    "110": "m9",
    "111": "m10"
};

// Return the internal version of the given id. This is for instance useful
// when several rack ids should map to the same internal id.
function internalId(id) {
    return id in mergedIdMap ? mergedIdMap[id] : id;
}

// Convert angle from degrees to radians.
function degree2rad(angle) {
    return angle * Math.PI / 180.0;
}

// Return the distance in km from (lat1, lon1) to (lat2, lon2).
// Algorithm: Spherical law of cosines for sufficient results down to 1 meter.
function distance(lat1, lon1, lat2, lon2) {
    lat1 = degree2rad(lat1);
    lat2 = degree2rad(lat2);
    lon1 = degree2rad(lon1);
    lon2 = degree2rad(lon2);
    var R = 6371; // radius of earth, in km
    return Math.acos(Math.sin(lat1) * Math.sin(lat2) +
                     Math.cos(lat1) * Math.cos(lat2) *
                     Math.cos(lon2 - lon1)) * R;
}

// Return an array of rack pairs from racks that are closer to each other than
// the given limit (in meters).
function detectReallyCloseRacks(limit, racks) {
    limit /= 1000;
    var results = [];
    for (var id1 in racks) {
        for (var id2 in racks) {
            var r1 = racks[id1];
            var r2 = racks[id2];
            var dist = distance(r1.lat, r1.lon, r2.lat, r2.lon);
            if (id1 < id2 && dist < limit) {
                results.push([id1, id2]);
            }
        }
    }
    return results;
}

// Return a new rack positioned between rack1 and rack2, with the name
// "rack1.name & rack2.name", and a the combined size of rack1 and rack2.
function mergeRacks(rack1, rack2) {
    return {
        "lat": (rack1.lat + rack2.lat) / 2,
        "lon": (rack1.lon + rack2.lon) / 2,
        "name": rack1.name === rack2.name ?
            rack1.name :
            rack1.name + ' & ' + rack2.name,
        "size": rack1.size + rack2.size
    };
}

function mergeCloseRacks(limit, racks) {
    var newRacks = {};
    var closePairs = detectReallyCloseRacks(limit, racks);
    for (var i = 0; i < closePairs.length; i++) {
        var id1 = closePairs[i][0];
        var id2 = closePairs[i][1];
        var merge = mergeRacks(racks[id1], racks[id2]);
        var newId = 'm' + i;
        mergedIdMap[id1] = newId;
        mergedIdMap[id2] = newId;
        newRacks[newId] = merge;
    }
    console.log(JSON.stringify(newRacks));
    console.log(JSON.stringify(mergedIdMap));
}
